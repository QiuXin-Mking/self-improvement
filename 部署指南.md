# 服务器部署指南

本指南提供了两种部署方式：Go二进制打包和直接部署。根据你的服务器环境选择最适合的方式。

## 方式一：Go二进制打包部署（推荐）

这种方式将Go应用编译成独立的可执行文件，无需在服务器上安装Go环境。

### 本地打包步骤

1. **确保已安装Go (>= 1.21)**
```bash
go version
```

2. **构建可执行文件**
```bash
# 构建CLI应用
go build -o bin/train main.go

# 构建Web应用
go build -o bin/web_app web_server.go
```

构建完成后，会在 `bin/` 目录生成可执行文件：
- Linux: `bin/train`, `bin/web_app`
- Windows: `bin/train.exe`, `bin/web_app.exe`
- macOS: `bin/train`, `bin/web_app`

3. **创建部署包**
手动创建 `deploy/` 目录，包含：
- 可执行文件
- `questions/` 目录（示例文件）
- `data/` 目录（数据存放）
- `README.md`

### 服务器部署

1. **上传部署包到服务器**
```bash
# 使用scp上传
scp -r deploy/* user@server:/opt/spaced-repetition-go/

# 或使用其他工具（如rsync）
rsync -av deploy/ user@server:/opt/spaced-repetition-go/
```

2. **SSH登录服务器**
```bash
ssh user@server
```

3. **设置权限**
```bash
cd /opt/spaced-repetition-go
chmod +x train  # Linux/Mac需要
chmod +x web_app  # Linux/Mac需要
```

4. **初始化知识库**
```bash
./train --init
```

5. **开始使用**
```bash
# 训练
./train

# 查看统计
./train --stats

# 启动Web服务
./web_app
```

### 优势
- ✅ 无需在服务器安装Go
- ✅ 单文件部署，简单方便
- ✅ 适合资源受限的服务器

---

## 方式二：直接部署（传统方式）

直接在服务器上安装Go环境并运行。

### 手动部署步骤

1. **安装Go**
```bash
# Ubuntu/Debian
wget https://golang.org/dl/go1.21.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.linux-amd64.tar.gz

# 添加到PATH
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc

# CentOS/RHEL
wget https://golang.org/dl/go1.21.linux-amd64.tar.gz
sudo tar -C /usr/local -xzf go1.21.linux-amd64.tar.gz

# 添加到PATH
echo 'export PATH=$PATH:/usr/local/go/bin' >> ~/.bashrc
source ~/.bashrc
```

2. **创建应用目录**
```bash
sudo mkdir -p /opt/spaced-repetition-go
sudo mkdir -p /opt/spaced-repetition-go/{questions,data}
```

3. **上传文件**
```bash
# 上传所有Go源文件和配置文件
scp -r main.go web_server.go internal/ go.mod go.sum Makefile questions/ user@server:/opt/spaced-repetition-go/
```

4. **安装依赖**
```bash
cd /opt/spaced-repetition-go
go mod tidy
```

5. **初始化知识库**
```bash
go run main.go --init
```

6. **使用**
```bash
# 训练
go run main.go

# 查看统计
go run main.go --stats

# 启动Web服务
go run web_server.go
```

### 创建systemd服务（可选，用于后台运行）

创建 `/etc/systemd/system/spaced-repetition-go.service`:

```ini
[Unit]
Description=Spaced Repetition Training System (Go)
After=network.target

[Service]
Type=simple
User=train
WorkingDirectory=/opt/spaced-repetition-go
ExecStart=/opt/spaced-repetition-go/web_app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

启用服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable spaced-repetition-go.service
sudo systemctl start spaced-repetition-go.service
```

### 优势
- ✅ 完全控制环境
- ✅ 适合需要自定义配置的场景
- ✅ 便于调试和开发

---

## 使用Makefile进行自动化部署

如果你在服务器上有Go环境，也可以使用Makefile：

```bash
# 安装依赖
make deps

# 构建所有二进制文件
make build

# 初始化
make init

# 运行CLI
make run-cli

# 运行Web服务
make run-web
```

## 常见问题

### 1. 字符编码问题

如果遇到中文显示乱码，确保：
- 终端支持UTF-8编码
- 文件使用UTF-8编码保存

Linux服务器设置：
```bash
export LANG=zh_CN.UTF-8
export LC_ALL=zh_CN.UTF-8
```

### 2. 权限问题

确保：
- 应用有读取 `questions/` 目录的权限
- 应用有写入 `data/` 目录的权限

```bash
chmod -R 755 /opt/spaced-repetition-go/questions
chmod -R 755 /opt/spaced-repetition-go/data
```

### 3. Go版本

确保使用Go 1.21或更高版本：
```bash
go version  # 检查版本
```

### 4. 数据备份

定期备份 `data/learning_data.json` 文件：
```bash
# 备份
cp data/learning_data.json data/learning_data.json.bak

# 或使用定时任务
crontab -e
# 添加：每天凌晨2点备份
0 2 * * * cp /opt/spaced-repetition-go/data/learning_data.json /opt/spaced-repetition-go/data/learning_data.json.$(date +\%Y\%m\%d)
```

---

## 部署方式对比

| 方式 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| Go二进制打包 | 无需Go环境，单文件部署 | 文件可能较大 | 简单快速部署 |
| 直接部署 | 性能好，完全控制，便于调试 | 需要配置Go环境 | 需要自定义配置 |

## 推荐方案

- **快速部署**：使用Go二进制打包
- **开发测试**：直接部署
- **生产环境**：Go二进制打包配合systemd服务

---

## 安全建议

1. **文件权限**：限制应用目录的访问权限
2. **用户隔离**：使用专用用户运行应用
3. **数据备份**：定期备份学习数据
4. **防火墙**：如果通过SSH访问，确保防火墙配置正确

## 后续维护

1. **更新问题文件**：直接编辑 `questions/` 目录下的 `.md` 文件
2. **重新初始化**：如果问题文件更新，可以删除 `data/learning_data.json` 后重新运行 `--init`
3. **查看日志**：检查系统日志或应用输出

---

如有问题，请查看项目README或提交Issue。

